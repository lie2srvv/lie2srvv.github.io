<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>lie2srvv | Ultra Performance</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background: #0a0a0a; color: #e0e0e0; font-family: 'Montserrat', sans-serif; overflow: hidden; }
        canvas { touch-action: none; }
        .card { background: #141414; border: 1px solid rgba(255,255,255,0.1); border-radius: 2rem; }
        .color-btn { width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent; transition: 0.2s; }
        .color-btn:active { transform: scale(0.8); }
        .active-color { border-color: white; transform: scale(1.1); }
        .rgb-text { background: linear-gradient(to right, red, orange, yellow, green, cyan, blue, violet); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        window.fb = { initializeApp, getFirestore, collection, addDoc, onSnapshot, Timestamp, getAuth, signInAnonymously };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [page, setPage] = useState('info');
            const [city, setCity] = useState('МОСКВА');
            const [paths, setPaths] = useState([]);
            const [currentColor, setCurrentColor] = useState('#FFFFFF');
            const [isRGB, setIsRGB] = useState(false);
            const [hue, setHue] = useState(0);
            const [question, setQuestion] = useState('');
            const [db, setDb] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [messages, setMessages] = useState([]);

            const canvasRef = useRef(null);
            const currentPathRef = useRef(null);

            // Инициализация базы
            useEffect(() => {
                if (window.fb && window.__firebase_config) {
                    const app = window.fb.initializeApp(JSON.parse(window.__firebase_config));
                    const _db = window.fb.getFirestore(app);
                    setDb(_db);
                    window.fb.signInAnonymously(window.fb.getAuth(app)).catch(console.error);
                }
            }, []);

            // Анимационный цикл (200Гц Friendly)
            useEffect(() => {
                const handle = requestAnimationFrame(function loop() {
                    setHue(h => (h + 2) % 360);
                    
                    if (page === 'draw' && canvasRef.current) {
                        const ctx = canvasRef.current.getContext('2d');
                        ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                        
                        const drawPath = (p) => {
                            if (!p.pts.length) return;
                            ctx.beginPath();
                            ctx.strokeStyle = p.c;
                            ctx.lineWidth = 4;
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';
                            ctx.moveTo(p.pts[0].x, p.pts[0].y);
                            p.pts.forEach(pt => ctx.lineTo(pt.x, pt.y));
                            ctx.stroke();
                        };

                        paths.forEach(drawPath);
                        if (currentPathRef.current) {
                            if (isRGB) currentPathRef.current.c = `hsl(${hue}, 100%, 50%)`;
                            drawPath(currentPathRef.current);
                        }
                    }
                    requestAnimationFrame(loop);
                });
                return () => cancelAnimationFrame(handle);
            }, [page, paths, hue, isRGB]);

            const getPos = (e) => {
                const r = canvasRef.current.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                return { x: clientX - r.left, y: clientY - r.top };
            };

            const startDrawing = (e) => {
                const color = isRGB ? `hsl(${hue}, 100%, 50%)` : currentColor;
                currentPathRef.current = { c: color, pts: [getPos(e)] };
            };

            const moveDrawing = (e) => {
                if (!currentPathRef.current) return;
                currentPathRef.current.pts.push(getPos(e));
            };

            const endDrawing = () => {
                if (currentPathRef.current) {
                    setPaths(prev => [...prev, currentPathRef.current]);
                    currentPathRef.current = null;
                }
            };

            const sendMessage = async () => {
                if (!question.trim() || !db) return;
                try {
                    await window.fb.addDoc(window.fb.collection(db, "questions"), {
                        text: question,
                        createdAt: window.fb.Timestamp.now()
                    });
                    setQuestion('');
                    alert("Вопрос улетел!");
                } catch (e) {
                    console.error("Full error:", e);
                    alert("Ошибка! Проверь консоль (F12)");
                }
            };

            return (
                <div className="h-screen w-full flex flex-col items-center justify-center p-4">
                    {/* Навигация */}
                    <div className="fixed top-6 flex gap-4 z-50 bg-[#1a1a1a] p-2 rounded-2xl border border-white/5">
                        {['info', 'draw', 'ask'].map(t => (
                            <button key={t} onClick={() => setPage(t)} className={`px-6 py-2 rounded-xl uppercase text-[10px] font-bold tracking-widest transition ${page === t ? 'bg-white text-black' : 'text-white/40'}`}>
                                {t === 'info' ? 'Профиль' : t === 'draw' ? 'Холст' : 'Вопросы'}
                            </button>
                        ))}
                    </div>

                    {page === 'info' && (
                        <div className="card p-10 max-w-md w-full animate-fade">
                            <h1 className="text-3xl font-bold mb-2">lie2srvv</h1>
                            <p className="text-white/30 text-xs mb-8">@lie2srvv</p>
                            <p className="text-sm leading-relaxed mb-8">Александр, 16 лет. Учусь в 11 классе. Увлекаюсь программированием. Чутка веб-разработчик.</p>
                            <div className="flex justify-between border-t border-white/5 pt-6">
                                <div><p className="text-[10px] text-white/20 uppercase font-bold">Страна</p><p>Россия</p></div>
                                <div className="text-right"><p className="text-[10px] text-white/20 uppercase font-bold">Локация</p><p className="font-mono">{city}</p></div>
                            </div>
                        </div>
                    )}

                    {page === 'draw' && (
                        <div className="absolute inset-0 flex items-center justify-center">
                            <canvas ref={canvasRef} width={window.innerWidth} height={window.innerHeight} 
                                onMouseDown={startDrawing} onMouseMove={moveDrawing} onMouseUp={endDrawing}
                                onTouchStart={startDrawing} onTouchMove={moveDrawing} onTouchEnd={endDrawing}
                            />
                            <div className="fixed bottom-10 bg-[#1a1a1a]/90 backdrop-blur-xl p-6 rounded-[2.5rem] border border-white/10 flex flex-col items-center gap-4">
                                <div className="flex gap-3 items-center">
                                    {['#FFFFFF', '#FF3B30', '#FF9500', '#FFCC00', '#4CD964', '#007AFF', '#5856D6'].map(c => (
                                        <button key={c} onClick={() => {setCurrentColor(c); setIsRGB(false);}} className={`color-btn ${currentColor === c && !isRGB ? 'active-color' : ''}`} style={{background: c}} />
                                    ))}
                                    <input type="color" onChange={(e) => {setCurrentColor(e.target.value); setIsRGB(false);}} className="w-8 h-8 rounded-full bg-transparent border-none cursor-pointer" />
                                    <button onClick={() => setIsRGB(!isRGB)} className={`px-4 py-2 rounded-full border border-white/10 text-[10px] font-bold uppercase transition ${isRGB ? 'bg-white text-black' : 'rgb-text'}`}>RGB</button>
                                </div>
                                <button onClick={() => setPaths([])} className="text-[8px] text-white/20 uppercase font-bold hover:text-white transition">Очистить холст</button>
                            </div>
                        </div>
                    )}

                    {page === 'ask' && (
                        <div className="card p-10 max-w-md w-full">
                            <h2 className="text-xl font-bold mb-6 uppercase tracking-tighter">Задать вопрос</h2>
                            <textarea value={question} onChange={e => setQuestion(e.target.value)} placeholder="Твое сообщение..." className="w-full h-40 bg-white/5 rounded-2xl p-4 text-sm focus:outline-none border border-white/5 mb-4 resize-none" />
                            <button onClick={sendMessage} className="w-full py-4 bg-white text-black font-bold rounded-2xl uppercase text-xs tracking-widest active:scale-95 transition">Отправить</button>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

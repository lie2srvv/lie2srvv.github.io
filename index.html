import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, Timestamp } from 'firebase/firestore';

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'lie2srvv-app';

const App = () => {
  const [user, setUser] = useState(null);
  const [currentPage, setCurrentPage] = useState('info');
  const [menuOpen, setMenuOpen] = useState(false);
  const [question, setQuestion] = useState('');
  const [questionsList, setQuestionsList] = useState([]);
  const [isSending, setIsSending] = useState(false);
  const [showAdmin, setShowAdmin] = useState(false);
  const [adminPass, setAdminPass] = useState('');
  const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
  const canvasRef = useRef(null);
  const [drawing, setDrawing] = useState(false);
  const [colorIdx, setColorIdx] = useState(0);
  const colors = ["#FFFFFF", "#FF0000", "#FF7F00", "#FFFF00", "#00FF00", "#0000FF", "#4B0082", "#9400D3", "rainbow"];
  const [hue, setHue] = useState(0);

  // 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. –°–ª—É—à–∞—Ç–µ–ª—å –≤–æ–ø—Ä–æ—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
  useEffect(() => {
    if (!user || !isAdminAuthenticated) return;
    const qCol = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
    const unsubscribe = onSnapshot(qCol, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setQuestionsList(data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
    }, (err) => console.error("Firestore error:", err));
    return () => unsubscribe();
  }, [user, isAdminAuthenticated]);

  // 3. –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞–¥—É–≥–∏
  useEffect(() => {
    let frame;
    const animate = () => {
      setHue(h => (h + 2) % 360);
      frame = requestAnimationFrame(animate);
    };
    frame = requestAnimationFrame(animate);
    return () => cancelAnimationFrame(frame);
  }, []);

  // 4. –ü–æ–¥—Å—Ç—Ä–æ–π–∫–∞ —Ö–æ–ª—Å—Ç–∞
  useEffect(() => {
    if (currentPage === 'draw' && canvasRef.current) {
      const canvas = canvasRef.current;
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
  }, [currentPage]);

  const sendQuestion = async () => {
    if (!question.trim() || isSending || !user) return;
    setIsSending(true);
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'questions'), {
        text: question,
        createdAt: Timestamp.now(),
        userId: user.uid
      });
      setQuestion('');
      alert('–í–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–Ω–æ–Ω–∏–º–Ω–æ!');
    } catch (e) {
      console.error(e);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ');
    } finally {
      setIsSending(false);
    }
  };

  const handleAdminAuth = () => {
    if (adminPass === 'Lie2Admin') {
      setIsAdminAuthenticated(true);
    } else {
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    }
  };

  const draw = (e) => {
    if (!drawing || !canvasRef.current) return;
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    
    const x = clientX - rect.left;
    const y = clientY - rect.top;

    ctx.strokeStyle = colors[colorIdx] === 'rainbow' ? `hsl(${hue}, 100%, 50%)` : colors[colorIdx];
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

  const startDrawing = (e) => {
    setDrawing(true);
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    ctx.beginPath();
    ctx.moveTo(clientX - rect.left, clientY - rect.top);
  };

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-['Montserrat'] overflow-hidden relative">
      {/* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–Ω–µ–≥ –Ω–∞ —Ñ–æ–Ω–µ */}
      <div className="fixed inset-0 pointer-events-none z-0 opacity-30">
        {[...Array(40)].map((_, i) => (
          <div 
            key={i}
            className="absolute bg-white rounded-full animate-snow"
            style={{
              left: `${Math.random() * 100}%`,
              width: `${Math.random() * 3 + 1}px`,
              height: `${Math.random() * 3 + 1}px`,
              animationDuration: `${Math.random() * 10 + 7}s`,
              animationDelay: `${Math.random() * 5}s`,
              top: '-5%'
            }}
          />
        ))}
      </div>

      {/* –ö–Ω–æ–ø–∫–∞ –ú–µ–Ω—é */}
      <button 
        onClick={() => setMenuOpen(!menuOpen)}
        className="fixed top-6 right-6 z-50 p-4 bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl hover:bg-white/10 transition-all active:scale-90"
      >
        <div className="w-6 h-5 flex flex-col justify-between items-end">
          <span className={`h-0.5 bg-white transition-all ${menuOpen ? 'w-6 rotate-45 translate-y-2' : 'w-6'}`} />
          <span className={`h-0.5 bg-white transition-all ${menuOpen ? 'opacity-0' : 'w-4'}`} />
          <span className={`h-0.5 bg-white transition-all ${menuOpen ? 'w-6 -rotate-45 -translate-y-2' : 'w-5'}`} />
        </div>
      </button>

      {/* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */}
      <div className={`fixed inset-0 z-40 bg-black/95 backdrop-blur-3xl transition-all duration-500 flex flex-col items-center justify-center gap-10 ${menuOpen ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0 pointer-events-none'}`}>
        {['info', 'draw', 'ask'].map((page) => (
          <button
            key={page}
            onClick={() => { setCurrentPage(page); setMenuOpen(false); }}
            className={`text-4xl font-bold transition-all ${currentPage === page ? 'text-cyan-400 scale-110' : 'text-white/40 hover:text-white hover:scale-105'}`}
          >
            {page === 'info' ? '–ü—Ä–æ—Ñ–∏–ª—å' : page === 'draw' ? '–•–æ–ª—Å—Ç' : '–í–æ–ø—Ä–æ—Å—ã'}
          </button>
        ))}
      </div>

      {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
      <main className="relative z-10 h-screen w-full flex items-center justify-center p-6">
        
        {currentPage === 'info' && (
          <div className="bg-white/[0.03] backdrop-blur-2xl border border-white/10 p-10 rounded-[2.5rem] max-w-md w-full shadow-2xl animate-in">
            <h1 className="text-3xl font-bold mb-2 tracking-tight">lie2srvv</h1>
            <p className="text-white/60 mb-8 font-medium">@lie2srvv</p>
            
            <div className="space-y-6">
              <div className="flex flex-col gap-1">
                <span className="text-[10px] uppercase tracking-[0.2em] text-white/30 font-bold">–õ–∏—á–Ω–æ–µ</span>
                <p className="text-white/90">–ê–ª–µ–∫—Å–∞–Ω–¥—Ä, 16 –ª–µ—Ç</p>
              </div>

              <div className="flex flex-col gap-1">
                <span className="text-[10px] uppercase tracking-[0.2em] text-white/30 font-bold">–õ–æ–∫–∞—Ü–∏—è</span>
                <p className="text-white/90">–†–æ—Å—Å–∏—è, –≥. <CityGenerator /></p>
              </div>

              <div className="flex flex-col gap-1">
                <span className="text-[10px] uppercase tracking-[0.2em] text-white/30 font-bold">–û —Å–µ–±–µ</span>
                <p className="text-white/90 text-sm leading-relaxed">–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä—É—é, —É—á—É—Å—å –≤ 11 –∫–ª–∞—Å—Å–µ, –ª—é–±–ª—é –ª–æ–≥–∏–∫—É –∏ —ç—Å—Ç–µ—Ç–∏–∫—É üå∏</p>
              </div>
            </div>

            <div className="h-px bg-white/10 my-8" />
            
            <div className="flex flex-col gap-4">
              <a href="https://t.me/lie2survive" target="_blank" className="flex items-center justify-between group p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-cyan-500/30 transition-all">
                <span className="font-bold">–¢–µ–ª–µ–≥—Ä–∞–º</span>
                <span className="text-cyan-400 group-hover:translate-x-1 transition-transform">‚Üí</span>
              </a>
              <a href="https://github.com/lie2srvv" target="_blank" className="flex items-center justify-between group p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-cyan-500/30 transition-all">
                <span className="font-bold">Github</span>
                <span className="text-cyan-400 group-hover:translate-x-1 transition-transform">‚Üí</span>
              </a>
            </div>
          </div>
        )}

        {currentPage === 'draw' && (
          <div className="absolute inset-0 touch-none">
            <canvas 
              ref={canvasRef}
              className="w-full h-full"
              onMouseDown={startDrawing}
              onMouseUp={() => setDrawing(false)}
              onMouseMove={draw}
              onTouchStart={(e) => startDrawing(e.touches[0])}
              onTouchEnd={() => setDrawing(false)}
              onTouchMove={(e) => draw(e.touches[0])}
            />
            <div className="fixed bottom-12 left-1/2 -translate-x-1/2 flex items-center gap-6 bg-black/80 backdrop-blur-2xl p-4 px-8 rounded-full border border-white/10 shadow-2xl animate-in">
              <button 
                onClick={() => setColorIdx((colorIdx + 1) % colors.length)}
                className="w-12 h-12 rounded-full border-4 border-white/20 transition-transform active:scale-90 shadow-inner"
                style={{ background: colors[colorIdx] === 'rainbow' ? `hsl(${hue}, 100%, 50%)` : colors[colorIdx] }}
              />
              <button 
                onClick={() => {
                  const ctx = canvasRef.current.getContext('2d');
                  ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                }}
                className="bg-white/10 hover:bg-white/20 px-6 py-3 rounded-full text-sm font-black uppercase tracking-widest transition-all"
              >
                Clear
              </button>
            </div>
          </div>
        )}

        {currentPage === 'ask' && (
          <div className="bg-white/[0.03] backdrop-blur-2xl border border-white/10 p-10 rounded-[2.5rem] max-w-md w-full shadow-2xl animate-in">
            {!isAdminAuthenticated ? (
              <>
                <h2 className="text-2xl font-bold mb-6">–ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤–æ–ø—Ä–æ—Å</h2>
                <textarea
                  value={question}
                  onChange={(e) => setQuestion(e.target.value)}
                  placeholder="–¢–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                  className="w-full bg-white/5 border border-white/10 rounded-[1.5rem] p-5 min-h-[140px] focus:outline-none focus:border-cyan-500/50 transition-all resize-none mb-6 placeholder:text-white/20"
                />
                <button
                  onClick={sendQuestion}
                  disabled={isSending || !question.trim()}
                  className="w-full bg-white text-black font-black py-5 rounded-[1.5rem] transition-all active:scale-95 disabled:opacity-20 uppercase tracking-widest"
                >
                  {isSending ? '...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}
                </button>
                
                <div className="mt-10 flex flex-col items-center">
                  <button 
                    onClick={() => setShowAdmin(!showAdmin)}
                    className="text-[10px] text-white/10 hover:text-white/40 transition-colors uppercase tracking-[0.3em]"
                  >
                    Admin Access
                  </button>
                  {showAdmin && (
                    <div className="mt-4 flex gap-2 w-full animate-in">
                      <input 
                        type="password" 
                        value={adminPass}
                        onChange={(e) => setAdminPass(e.target.value)}
                        placeholder="Pass"
                        className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 text-sm focus:outline-none"
                      />
                      <button onClick={handleAdminAuth} className="bg-cyan-500 text-black px-4 py-2 rounded-xl text-xs font-bold">OK</button>
                    </div>
                  )}
                </div>
              </>
            ) : (
              <div className="h-[450px] flex flex-col">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="font-bold text-xl">Inbox ({questionsList.length})</h2>
                  <button onClick={() => setIsAdminAuthenticated(false)} className="text-xs text-cyan-400 font-bold uppercase tracking-widest">Logout</button>
                </div>
                <div className="flex-1 overflow-y-auto pr-2 space-y-4 custom-scroll">
                  {questionsList.map(q => (
                    <div key={q.id} className="bg-white/5 border border-white/5 p-5 rounded-2xl border-l-2 border-l-cyan-500/50">
                      <p className="text-sm leading-relaxed text-white/90">{q.text}</p>
                      <p className="text-[10px] text-white/20 mt-3 font-mono">
                        {q.createdAt?.toDate().toLocaleString() || 'Just now'}
                      </p>
                    </div>
                  ))}
                  {questionsList.length === 0 && (
                    <div className="h-full flex flex-col items-center justify-center opacity-20">
                      <p>–ü—É—Å—Ç–æ</p>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        )}
      </main>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes snow {
          0% { transform: translateY(0) rotate(0deg); }
          100% { transform: translateY(110vh) rotate(360deg); }
        }
        .animate-snow { animation-name: snow; animation-iteration-count: infinite; animation-timing-function: linear; }
        .animate-in { animation: in 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes in {
          from { opacity: 0; transform: translateY(30px) scale(0.95); }
          to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
      `}} />
    </div>
  );
};

const CityGenerator = () => {
  const [city, setCity] = useState('');
  useEffect(() => {
    const letters = "–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è";
    const interval = setInterval(() => {
      let c = letters[Math.floor(Math.random() * letters.length)].toUpperCase();
      for (let i = 0; i < 5; i++) c += letters[Math.floor(Math.random() * letters.length)];
      setCity(c);
    }, 50);
    return () => clearInterval(interval);
  }, []);
  return <span className="italic font-bold text-white/40">{city}</span>;
};

export default App;                 

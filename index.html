<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>lie2srvv</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --bg-deep: #0a0a0a;
            --bg-card: #141414;
            --text-main: #e0e0e0;
        }
        
        body, html { 
            background-color: var(--bg-deep); 
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Montserrat', sans-serif; color: var(--text-main); 
            overflow: hidden; touch-action: none; 
        }

        #snow-canvas { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 1; 
        }

        #root { position: relative; z-index: 10; width: 100%; height: 100%; }

        .animate-fade { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--bg-card); 
            border: 1px solid rgba(255,255,255,0.07); 
            border-radius: 2.5rem; 
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7);
        }

        canvas#drawing-canvas { cursor: crosshair; touch-action: none; }
        
        .color-dot { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .color-dot.active { transform: scale(1.3); border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }

        .nav-link {
            width: 80%;
            max-width: 300px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        window.fb = { initializeApp, getFirestore, collection, addDoc, onSnapshot, Timestamp, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const startSnow = () => {
            const canvas = document.getElementById('snow-canvas');
            const ctx = canvas.getContext('2d');
            let w, h, particles = [];

            const resize = () => {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
            };

            class Particle {
                constructor() { this.init(); }
                init() {
                    this.x = Math.random() * w;
                    this.y = Math.random() * -h;
                    this.size = Math.random() * 4 + 2.5;
                    this.speed = Math.random() * 0.5 + 0.25;
                    this.opacity = Math.random() * 0.4 + 0.2;
                    this.swing = Math.random() * 3 + 1.5;
                    this.offset = Math.random() * 2000;
                }
                update() {
                    this.y += this.speed;
                    this.x += Math.sin((Date.now() + this.offset) * 0.0015) * 0.6;
                    if (this.y > h) this.init();
                }
                draw() {
                    ctx.beginPath();
                    const g = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
                    g.addColorStop(0, `rgba(255,255,255,${this.opacity})`);
                    g.addColorStop(0.5, `rgba(255,255,255,${this.opacity * 0.3})`);
                    g.addColorStop(1, 'transparent');
                    ctx.fillStyle = g;
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            window.addEventListener('resize', resize);
            resize();
            for(let i=0; i<65; i++) particles.push(new Particle());

            const animate = () => {
                ctx.clearRect(0,0,w,h);
                particles.forEach(p => { p.update(); p.draw(); });
                requestAnimationFrame(animate);
            };
            animate();
        };

        const App = () => {
            const [currentPage, setCurrentPage] = useState('info');
            const [menuOpen, setMenuOpen] = useState(false);
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [question, setQuestion] = useState('');
            const [questions, setQuestions] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [city, setCity] = useState('...');
            const [paths, setPaths] = useState([]);
            const [colorIdx, setColorIdx] = useState(0);
            const colors = ["#FFFFFF", "#FF3B30", "#FFCC00", "#4CD964", "#007AFF", "#AF52DE", "rainbow"];
            const [hue, setHue] = useState(0);

            const canvasRef = useRef(null);
            const currentPathRef = useRef(null);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'lie2srvv-v6';

            useEffect(() => {
                startSnow();
                const initFirebase = async () => {
                    if (window.fb && window.__firebase_config) {
                        try {
                            const config = JSON.parse(window.__firebase_config);
                            const app = window.fb.initializeApp(config);
                            const _db = window.fb.getFirestore(app);
                            const _auth = window.fb.getAuth(app);
                            setDb(_db);
                            
                            const res = await window.fb.signInAnonymously(_auth);
                            setUser(res.user);
                        } catch(e) { console.error("Firebase init failed", e); }
                    }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (db && user && isAdmin) {
                    const q = window.fb.collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                    return window.fb.onSnapshot(q, (s) => {
                        setQuestions(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                    }, (err) => console.log(err));
                }
            }, [db, user, isAdmin]);

            useEffect(() => {
                const chars = "абвгдеёжзийклмнопрстуфхцчшщъыьэюя";
                const timer = setInterval(() => {
                    setHue(h => (h + 1) % 360);
                    if(Math.random() > 0.96) {
                        setCity(Array(6).fill(0).map(() => chars[Math.floor(Math.random()*chars.length)]).join('').toUpperCase());
                    }
                    if(currentPage === 'draw' && canvasRef.current) {
                        const ctx = canvasRef.current.getContext('2d');
                        ctx.clearRect(0,0,canvasRef.current.width, canvasRef.current.height);
                        // Отрисовка всех сохраненных путей + текущего
                        [...paths, currentPathRef.current].filter(Boolean).forEach(p => {
                            if (!p.pts?.length) return;
                            ctx.beginPath();
                            ctx.lineWidth = 3.5;
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';
                            ctx.strokeStyle = p.c === 'rainbow' ? `hsl(${p.h}, 100%, 75%)` : p.c;
                            ctx.moveTo(p.pts[0].x, p.pts[0].y);
                            p.pts.forEach(pt => ctx.lineTo(pt.x, pt.y));
                            ctx.stroke();
                        });
                    }
                }, 16);
                return () => clearInterval(timer);
            }, [currentPage, paths, hue]);

            const getPos = (e) => {
                if (!canvasRef.current) return { x: 0, y: 0 };
                const r = canvasRef.current.getBoundingClientRect();
                const x = (e.clientX || (e.touches && e.touches[0].clientX)) - r.left;
                const y = (e.clientY || (e.touches && e.touches[0].clientY)) - r.top;
                return { x, y };
            };

            const handleDrawStart = (e) => {
                currentPathRef.current = { c: colors[colorIdx], pts: [getPos(e)], h: hue };
            };

            const handleDrawMove = (e) => {
                if (currentPathRef.current) {
                    currentPathRef.current.pts.push(getPos(e));
                }
            };

            const handleDrawEnd = () => {
                if (currentPathRef.current) {
                    setPaths(prev => [...prev, currentPathRef.current]);
                    currentPathRef.current = null;
                }
            };

            const sendMsg = async () => {
                if(!question.trim() || !db || !user) {
                    if (!user) console.error("Auth not ready");
                    return;
                }
                try {
                    const col = window.fb.collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                    await window.fb.addDoc(col, {
                        text: question,
                        createdAt: window.fb.Timestamp.now(),
                        uid: user.uid
                    });
                    setQuestion('');
                    alert('Отправлено анонимно!');
                } catch(e) { 
                    console.error(e);
                    alert('Ошибка отправки. Попробуйте еще раз.'); 
                }
            };

            return (
                <div className="w-full h-full flex items-center justify-center p-4">
                    <button onClick={() => setMenuOpen(!menuOpen)} className="fixed top-8 right-8 z-[110] p-4 bg-[#1a1a1a] border border-white/10 rounded-2xl active:scale-90 transition-all shadow-xl">
                        <div className="w-6 h-4 flex flex-col justify-between items-end">
                            <span className={`h-0.5 bg-white transition-all ${menuOpen ? 'w-6 rotate-45 translate-y-2' : 'w-6'}`} />
                            <span className={`h-0.5 bg-white transition-all ${menuOpen ? 'opacity-0' : 'w-4'}`} />
                            <span className={`h-0.5 bg-white transition-all ${menuOpen ? 'w-6 -rotate-45 -translate-y-1.5' : 'w-5'}`} />
                        </div>
                    </button>

                    <nav className={`fixed inset-0 z-[100] bg-[#0a0a0ae0] backdrop-blur-2xl transition-all duration-500 flex flex-col items-center justify-center gap-6 ${menuOpen ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'}`}>
                        <button onClick={() => {setCurrentPage('info'); setMenuOpen(false);}} className="nav-link">
                            <span className={`text-xl font-bold uppercase tracking-widest ${currentPage === 'info' ? 'text-white' : 'text-[#555]'}`}>Профиль</span>
                        </button>
                        <button onClick={() => {setCurrentPage('draw'); setMenuOpen(false);}} className="nav-link">
                            <span className={`text-xl font-bold uppercase tracking-widest ${currentPage === 'draw' ? 'text-white' : 'text-[#555]'}`}>Холст</span>
                        </button>
                        <button onClick={() => {setCurrentPage('ask'); setMenuOpen(false);}} className="nav-link">
                            <span className={`text-xl font-bold uppercase tracking-widest ${currentPage === 'ask' ? 'text-white' : 'text-[#555]'}`}>Вопросы</span>
                        </button>
                    </nav>

                    <main className="w-full h-full flex items-center justify-center">
                        {currentPage === 'info' && (
                            <div className="card p-10 max-w-md w-full animate-fade">
                                <div className="flex justify-between items-start mb-8">
                                    <h1 className="text-3xl font-bold">lie2srvv</h1>
                                    <span className="text-[10px] font-mono text-white/20">@lie2srvv</span>
                                </div>
                                <p className="text-sm text-[#999] leading-relaxed mb-10">Александр, 16 лет. Учусь в 11 классе. Увлекаюсь программированием. Чутка веб-разработчик.</p>
                                <div className="flex justify-between items-end mb-10">
                                    <div className="space-y-1">
                                        <p className="text-[10px] uppercase tracking-widest text-[#444] font-bold">Страна</p>
                                        <p className="text-sm text-white font-medium">Россия</p>
                                    </div>
                                    <div className="space-y-1 text-right">
                                        <p className="text-[10px] uppercase tracking-widest text-[#444] font-bold">Локация</p>
                                        <p className="text-sm text-[#666] font-mono font-bold uppercase">{city}</p>
                                    </div>
                                </div>
                                <a href="https://t.me/lie2survive" target="_blank" className="block text-center p-5 bg-white/5 border border-white/5 rounded-3xl font-bold text-xs uppercase tracking-widest text-[#aaa] hover:bg-white/10 transition-all active:scale-95">Связаться в Telegram</a>
                            </div>
                        )}

                        {currentPage === 'draw' && (
                            <div className="absolute inset-0">
                                <canvas ref={canvasRef} id="drawing-canvas" width={window.innerWidth} height={window.innerHeight}
                                    onMouseDown={handleDrawStart}
                                    onMouseMove={handleDrawMove}
                                    onMouseUp={handleDrawEnd}
                                    onMouseLeave={handleDrawEnd}
                                    onTouchStart={handleDrawStart}
                                    onTouchMove={handleDrawMove}
                                    onTouchEnd={handleDrawEnd}
                                />
                                <div className="fixed bottom-10 left-1/2 -translate-x-1/2 flex flex-col items-center gap-5 bg-[#141414]/95 backdrop-blur-2xl p-6 rounded-[3rem] border border-white/10 shadow-2xl">
                                    <div className="flex gap-3">
                                        {colors.map((c, i) => (
                                            <button key={i} onClick={() => setColorIdx(i)} className={`color-dot ${colorIdx === i ? 'active' : ''}`} 
                                                style={{background: c === 'rainbow' ? 'linear-gradient(45deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f)' : c}} />
                                        ))}
                                    </div>
                                    <button onClick={() => setPaths([])} className="text-[9px] font-bold uppercase tracking-widest text-[#333] hover:text-white transition-colors">Очистить всё</button>
                                </div>
                            </div>
                        )}

                        {currentPage === 'ask' && (
                            <div className="card p-10 max-w-md w-full animate-fade">
                                {!isAdmin ? (
                                    <>
                                        <h2 className="text-xl font-bold mb-8 uppercase tracking-widest text-center">Задать вопрос</h2>
                                        <textarea value={question} onChange={e => setQuestion(e.target.value)} placeholder="Напиши что-нибудь анонимно..." className="w-full bg-white/[0.03] border border-white/5 rounded-2xl p-6 min-h-[160px] text-sm text-[#888] focus:outline-none focus:border-white/20 transition-all mb-6 resize-none" />
                                        <button onClick={sendMsg} className="w-full bg-[#f0f0f0] text-black font-bold py-5 rounded-2xl text-[10px] uppercase tracking-widest shadow-lg active:scale-95 transition-all">Отправить сообщение</button>
                                        <button onClick={() => { if(prompt('Пароль?') === 'Lie2Admin') setIsAdmin(true); }} className="mt-10 block mx-auto text-[8px] text-[#222] uppercase tracking-[0.4em] hover:text-[#444]">Admin Access</button>
                                    </>
                                ) : (
                                    <div className="h-[480px] flex flex-col">
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-[10px] uppercase tracking-widest text-[#444] font-bold">Входящие</h2>
                                            <button onClick={() => setIsAdmin(false)} className="text-[10px] text-white/20 uppercase font-bold hover:text-white">Выйти</button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto space-y-4 pr-2 custom-scroll">
                                            {questions.length > 0 ? questions.map(q => (
                                                <div key={q.id} className="bg-white/5 p-5 rounded-2xl border border-white/5">
                                                    <p className="text-sm text-[#aaa] leading-relaxed">{q.text}</p>
                                                    <p className="text-[8px] text-[#333] mt-4 font-mono uppercase">
                                                        {q.createdAt ? new Date(q.createdAt.seconds * 1000).toLocaleString() : 'Только что'}
                                                    </p>
                                                </div>
                                            )) : <p className="text-center text-[#222] mt-20 text-[10px] uppercase tracking-widest">Сообщений нет</p>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
